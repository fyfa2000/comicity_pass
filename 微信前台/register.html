<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,minimal-ui:ios">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>电子出入证申请</title>
    <link rel="stylesheet" href="__ROOT__/tpl/simplebootx_mobile/Mobile/Pass/css/weui.css">
    <link rel="stylesheet" href="__ROOT__/tpl/simplebootx_mobile/Mobile/Pass/css/app.css">
    <script src=""></script>
</head>

<body>


<section class="container">
    <div class="weui-form">
        <div class="weui-form__text-area">
            <h2 class="weui-form__title">电子出入证申请</h2>
        </div>
        <div class="weui-form__control-area">
            <div class="weui-cells__group weui-cells__group_form">
                <!--<input type="hidden" name="id" value="{$info.id}">-->
                <div class="weui-cells__title">基本信息</div>
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"><span style="color: #f00">*</span>姓名</label></div>
                        <div class="weui-cell__bd">
                            <input id="js_input_name" class="weui-input"  value="{$info.name}" placeholder="请输入姓名" >
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"><span style="color: #f00">*</span>手机号码</label></div>
                        <div class="weui-cell__bd">
                            <input id="js_input_mobile" class="weui-input" placeholder="请输入手机号码"  value="{$info.phone}" >
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"><span style="color: #f00">*</span>身份证</label></div>
                        <div class="weui-cell__bd">
                            <input id="js_input_id" class="weui-input" placeholder="请输入身份证"  value="{$info.card_id}">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label">商铺号</label></div>
                        <div class="weui-cell__bd">
                            <input id="js_input_num" class="weui-input"  value="{$info.store_id}" placeholder="请输入商铺号">
                        </div>
                    </div>

                    <div class="weui-cells__title" style="margin-top: 20px;">类型</div>
                    <div class="weui-cells weui-cells_radio">
                        <label class="weui-cell weui-cell_active weui-check__label" for="x11">
                            <div class="weui-cell__bd">
                                <p>员工</p>
                            </div>
                            <div class="weui-cell__ft">
                                <input type="radio" class="weui-check" name="radio1" id="x11" checked="checked" value="1" <if condition='$info.type eq 1'>checked</if>>
                                <span class="weui-icon-checked"></span>
                            </div>
                        </label>
                        <label class="weui-cell weui-cell_active weui-check__label" for="x12">

                            <div class="weui-cell__bd">
                                <p>施工人员</p>
                            </div>
                            <div class="weui-cell__ft">
                                <input type="radio" name="radio1" class="weui-check" id="x12" value="2" <if condition='$info.type eq 2'>checked</if>>
                                <span class="weui-icon-checked"></span>
                            </div>
                        </label>

                    </div>




                    <div class="weui-cells__title" style="margin-top: 20px;">图片上传</div>

                    <div class="weui-gallery" id="gallery">
                        <span class="weui-gallery__img" id="galleryImg"></span>
                        <div class="weui-gallery__opr">
                            <a href="javascript:" class="weui-gallery__del" data-img>
                                <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                            </a>
                        </div>
                    </div>
                    <div class="weui-cell  weui-cell_uploader">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    <p class="weui-uploader__title"><span style="color: #f00">*</span>上传照片</p>

                                    <!-- <div class="weui-uploader__info">0/2</div> -->
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="uploaderFiles">
                                        <foreach name="info.uploaderImg1" item="v">
                                            <neq name="v" value="http://t.comicity.cn/">
                                                <li class="weui-uploader__file" data-url="{$v}" data-input="{$v}" style="background-image: url({$v});"></li>
                                            </neq>
                                        </foreach>
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="weui-gallery" id="gallery02">
                        <span class="weui-gallery__img" id="galleryImg02"></span>
                        <div class="weui-gallery__opr">
                            <a href="javascript:" class="weui-gallery__del" data-img-id>
                                <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                            </a>
                        </div>
                    </div>

                    <div class="weui-cell  weui-cell_uploader">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    <p class="weui-uploader__title"><span style="color: #f00">*</span> 请上传身份证正反面</p>

                                    <!-- <div class="weui-uploader__info">0/2</div> -->
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="uploaderFiles02">
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                        <foreach name="info.uploaderImg2" item="v">
                                            <neq name="v" value="http://t.comicity.cn/">
                                                <li class="weui-uploader__file"  data-url="{$v}" data-input="{$v}" style="background-image: url({$v});"></li>
                                            </neq>
                                        </foreach>
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input id="uploaderInput02" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="weui-gallery" id="gallery03">
                        <span class="weui-gallery__img" id="galleryImg03"></span>
                        <div class="weui-gallery__opr">
                            <a href="javascript:" class="weui-gallery__del" data-img-other>
                                <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                            </a>
                        </div>
                    </div>
                    <div class="weui-cell  weui-cell_uploader">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    <p class="weui-uploader__title">其它证照，例:电工证，焊工证等(可选)</p>
                                    <!-- <div class="weui-uploader__info">0/2</div> -->
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="uploaderFiles03">
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                        <!-- <li class="weui-uploader__file" style="background-image: url(https://weui.io/images/pic_160.png);"></li> -->
                                        <foreach name="info.uploaderImg3" item="v">
                                            <neq name="v" value="http://t.comicity.cn/">
                                                <li class="weui-uploader__file"  data-url="{$v}" data-input="{$v}" style="background-image: url({$v});"></li>
                                            </neq>
                                        </foreach>
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input id="uploaderInput03" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>
        </div>
        <div class="weui-form__tips-area">
            <!-- <p class="weui-form__tips">
              表单页提示，居中对齐
            </p> -->
        </div>
        <div class="weui-form__opr-area">
            <a class="weui-btn weui-btn_primary" href="javascript:" id="showTooltips">提交</a>
        </div>

        <!-- 上传图片 -->
        <input type="hidden" name="num" class="data-img" value=""/>

        <!-- 身份证 -->
        <input type="hidden" name="id[]" class="data-img-id" value=""/>
        <input type="hidden" name="id[]" class="data-img-id" value=""/>

        <!-- 其他照片 -->
        <input type="hidden" name="other[]" class="data-img-other" value=""/>
        <input type="hidden" name="other[]" class="data-img-other" value=""/>
        <input type="hidden" name="other[]" class="data-img-other" value=""/>
        <input type="hidden" name="other[]" class="data-img-other" value=""/>
        <input type="hidden" name="other[]" class="data-img-other" value=""/>


    </div>
</section>
<div class="weui-toptips weui-toptips_warn" id="topTips"></div>
</body>

<script src="__ROOT__/tpl/simplebootx_mobile/Mobile/Pass/js/zepto.min.js"></script>
<script src="__ROOT__/tpl/simplebootx_mobile/Mobile/Pass/js/weui.js"></script>
<script>
    $(function(){

        if($("#uploaderFiles li").length >=1) {
            $(".weui-uploader__input-box").eq(0).hide()
        }
        if($("#uploaderFiles02 li").length >=2) {
            $(".weui-uploader__input-box").eq(1).hide()
        }
        if($("#uploaderFiles03 li").length >=5) {
            $(".weui-uploader__input-box").eq(2).hide()
        }
    })
</script>
<script type="text/javascript">
    //上传图片地址
    var imgUrl1 = '{:U("Asset/Asset2/up_base64")}', //上传图片
        imgUrl2 = '{:U("Asset/Asset2/up_base64")}', //上传身份证
        imgUrl3 = '{:U("Asset/Asset2/up_base64")}'; //上传其他图片


    $(function(){
        $("#showTooltips").on("click",function(){
            var name = $("#js_input_name").val();
            var mobile = $("#js_input_mobile").val();
            var idCard = $("#js_input_id").val();
            var num = $("#js_input_num").val();
            var type = $("[name=radio1]:checked").val();
            var topTips = $("#topTips");

            if(!name){topTips.html("姓名不能为空");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }
            if(!checkPhone(mobile)){topTips.html("手机号码有误");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }
            if(!idCard){topTips.html("身份证不能为空");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }
            if(!validateIdCard(idCard)){
                topTips.html("身份证格式错误");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }
            if(!( $("#uploaderFiles li").length>0 )){
                topTips.html("请上传图片");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }
            if(!( $("#uploaderFiles02 li").length>1 )){
                topTips.html("请上传身份证正反面");
                topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
                return false;
            }



            // if(!$("#uploaderFiles03 li").length>0){
            //     topTips.html("请上传其他证照");
            //     topTips.fadeIn(200);setTimeout(function(){topTips.fadeOut(200)},2000)
            //     return false;
            // }

            var uploaderImg1 = [],   // 上传照片
                uploaderImg2 = [],   //身份证
                uploaderImg3 = [];   //其他照片

            $("#uploaderFiles li").each(function(){uploaderImg1.push($(this).attr("data-input"))})
            $("#uploaderFiles02 li").each(function(){uploaderImg2.push($(this).attr("data-input"))})
            $("#uploaderFiles03 li").each(function(){uploaderImg3.push($(this).attr("data-input"))})


            $.post(
                '{:U("register")}',
                {name:name,card_id:idCard,phone:mobile,store_id:num,type:type,id:"{$info.id}",
                    uploaderImg1:uploaderImg1,
                    uploaderImg2:uploaderImg2,
                    uploaderImg3:uploaderImg3,
                },
                function(res){

                    // 提交成功
                    console.log(res);
                    window.location.href="http://t.comicity.cn/index.php?s=/Mobile/Pass/index/id/" + res.a

                },"json")


        })
    })
    $(function(){

        var $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
            $uploaderInput = $("#uploaderInput"),
            $uploaderFiles = $("#uploaderFiles");

        $uploaderInput.on("change", function(e){
            var that = this;
            var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
            for (let i = 0, len = files.length; i < len; ++i) {
                var file = files[i];
                var oFReader = new FileReader();
                oFReader.readAsDataURL(file);
                oFReader.onload = function (oFREvent) {

                    $.post(imgUrl1,{img:oFREvent.target.result},function(res){

                        $("input.data-img").val(res.url)

                        if (url) {
                            src = url.createObjectURL(file);
                        } else {
                            src = e.target.result;
                        }

                        var tmpl = '<li class="weui-uploader__file" data-url="#url#" style="background-image:url(#url#)" data-input="'+res.url+'"></li>';
                        $uploaderFiles.append($(tmpl.replace(/#url#/g, src)));

                        //限制上传文件的数量
                        if($uploaderFiles.children().length>=1){
                            $(that).parent().hide();
                        }
                    },"json");
                };

            }
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $('[data-img]').attr("data-url", this.getAttribute("data-url"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });

        $('[data-img]').on("click",function(){
            // cardInput.val("");
            var url = $(this).attr('data-url');

            $uploaderFiles.find("li").each(function(){
                console.log($(this).attr("data-url"))
                if($(this).attr("data-url") == url){
                    $(this).remove()
                    return false
                }
            });

            $uploaderInput.parent().show();
        });
    });


    $(function(){
        // var tmpl = '<li class="weui-uploader__file" data-url="#url#" style="background-image:url(#url#)"></li>',
        var $gallery = $("#gallery02"), $galleryImg = $("#galleryImg02"),
            $uploaderInput = $("#uploaderInput02"),
            $uploaderFiles = $("#uploaderFiles02");

        $uploaderInput.on("change", function(e){
            var that = this;
            var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
            for (let i = 0, len = files.length; i < len; ++i) {
                var file = files[i];

                var oFReader = new FileReader();
                oFReader.readAsDataURL(file);
                oFReader.onload = function (oFREvent) {

                    $.post(imgUrl2,{img:oFREvent.target.result},function(res){

                        $("input.data-img-id").eq(i).val(res.url)

                        // cardInput.get($uploaderFiles.children().length).value = data.url;

                        if (url) {
                            src = url.createObjectURL(file);
                        } else {
                            src = e.target.result;
                        }


                        var tmpl = '<li class="weui-uploader__file" data-url="#url#" style="background-image:url(#url#)" data-input="'+res.url+'"></li>';
                        $uploaderFiles.append($(tmpl.replace(/#url#/g, src)));
                        //限制上传文件的数量
                        if($uploaderFiles.children().length>=2){
                            $(that).parent().hide();
                        }
                    },"json");
                };

            }
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
            $('[data-img-id]').attr("data-url", this.getAttribute("data-url"));
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });

        $('[data-img-id]').on("click",function(){
            // cardInput.val("");
            // $uploaderFiles.children(":first-child").remove();
            var url = $(this).attr('data-url');

            $uploaderFiles.find("li").each(function(){
                console.log($(this).attr("data-url"))
                if($(this).attr("data-url") == url){
                    $(this).remove()
                    return false
                }
            });
            $uploaderInput.parent().show();
        });
    });


    $(function(){
        // var tmpl = '<li class="weui-uploader__file" data-url="#url#" style="background-image:url(#url#)"></li>',
        var $gallery = $("#gallery03"), $galleryImg = $("#galleryImg03"),
            $uploaderInput = $("#uploaderInput03"),
            $uploaderFiles = $("#uploaderFiles03");

        $uploaderInput.on("change", function(e){
            var that = this;
            var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
            for (let i = 0, len = files.length; i < len; ++i) {
                var file = files[i];

                var oFReader = new FileReader();
                oFReader.readAsDataURL(file);
                oFReader.onload = function (oFREvent) {
                    $.post(imgUrl3,{img:oFREvent.target.result},function(res){

                        // cardInput.get($uploaderFiles.children().length).value = data.url;

                        if (url) {
                            src = url.createObjectURL(file);
                        } else {
                            src = e.target.result;
                        }
                        var tmpl = '<li class="weui-uploader__file" data-url="#url#" style="background-image:url(#url#)" data-input="'+res.url+'"></li>';
                        $uploaderFiles.append($(tmpl.replace(/#url#/g, src)));
                        //限制上传文件的数量
                        if($uploaderFiles.children().length>=5){
                            $(that).parent().hide();
                        }
                    },"json");
                };

            }
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
            $('[data-img-other]').attr("data-url", this.getAttribute("data-url"));
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });

        $('[data-img-other]').on("click",function(){
            // cardInput.val("");
            // $uploaderFiles.children(":first-child").remove();
            var url = $(this).attr('data-url');

            $uploaderFiles.find("li").each(function(){
                console.log($(this).attr("data-url"))
                if($(this).attr("data-url") == url){
                    $(this).remove()
                    return false
                }
            });

            $uploaderInput.parent().show();
        });
    });



    function checkPhone(phone){
        if(!(/^1[3456789]\d{9}$/.test(phone))){
            // alert("手机号码有误，请重填");
            return false;
        }else{
            return true
        }
    }

    // // 函数参数必须是字符串，因为二代身份证号码是十八位，而在javascript中，十八位的数值会超出计算范围，造成不精确的结果，导致最后两位和计算的值不一致，从而该函数出现错误。
    // // 详情查看javascript的数值范围
    function validateIdCard(idCard){
        var vcity={ 11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",
            21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",
            33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",
            42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",
            51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",
            63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"
        };
        //是否为空
        if(idCard === ''){
            return false;
        }
        //校验长度，类型
        if(isCardNo(idCard) === false){
            return false;
        }
        //检查省份
        if(checkProvince(idCard,vcity) === false){
            return false;
        }
        //校验生日
        if(checkBirthday(idCard) === false){
            return false;
        }
        //检验位的检测
        if(checkParity(idCard) === false){
            return false;
        }
        return true;
    }

    function isCardNo(card){
        //身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X
        var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
        if(reg.test(card) === false){
            return false;
        }
        return true;
    }

    function checkProvince(card,vcity){
        var province = card.substr(0,2);
        if(vcity[province] == undefined){
            return false;
        }
        return true;
    };

    function checkBirthday(card){
        var len = card.length;
        //身份证15位时，次序为省（3位）市（3位）年（2位）月（2位）日（2位）校验位（3位），皆为数字
        if(len == '15'){
            var re_fifteen = /^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/;
            var arr_data = card.match(re_fifteen);
            var year = arr_data[2];
            var month = arr_data[3];
            var day = arr_data[4];
            var birthday = new Date('19'+year+'/'+month+'/'+day);
            return verifyBirthday('19'+year,month,day,birthday);
        }
        //身份证18位时，次序为省（3位）市（3位）年（4位）月（2位）日（2位）校验位（4位），校验位末尾可能为X
        if(len == '18'){
            var re_eighteen = /^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X|x)$/;
            var arr_data = card.match(re_eighteen);
            var year = arr_data[2];
            var month = arr_data[3];
            var day = arr_data[4];
            var birthday = new Date(year+'/'+month+'/'+day);
            return verifyBirthday(year,month,day,birthday);
        }
        return false;
    };

    function verifyBirthday(year,month,day,birthday)
    {
        var now = new Date();
        var now_year = now.getFullYear();
        //年月日是否合理
        if(birthday.getFullYear() == year && (birthday.getMonth() + 1) == month && birthday.getDate() == day)
        {
            //判断年份的范围（0岁到100岁之间)
            var time = now_year - year;
            if(time >= 0 && time <= 100)
            {
                return true;
            }
            return false;
        }
        return false;
    }

    function checkParity(card){
        //15位转18位
        card = changeFivteenToEighteen(card);
        var len = card.length;
        if(len == '18'){
            var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
            var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
            var cardTemp = 0, i, valnum;
            for(i = 0; i < 17; i ++) {
                cardTemp += card.substr(i, 1) * arrInt[i];
            }
            valnum = arrCh[cardTemp % 11];
            if (valnum == card.substr(17, 1).toLocaleUpperCase())
            {
                return true;
            }
            return false;
        }
        return false;
    }

    function changeFivteenToEighteen(card){
        if(card.length == '15')
        {
            var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
            var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
            var cardTemp = 0, i;
            card = card.substr(0, 6) + '19' + card.substr(6, card.length - 6);
            for(i = 0; i < 17; i ++)
            {
                cardTemp += card.substr(i, 1) * arrInt[i];
            }
            card += arrCh[cardTemp % 11];
            return card;
        }
        return card;
    }
</script>
</html>