<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="/ticket/gzwhgy/themes/simplebootx/Portal/Events/Mobile/css/reset.css">
    <link rel="stylesheet" href="/ticket/gzwhgy/themes/simplebootx/Portal/Events/Mobile/css/weui.min.css">
    <link rel="stylesheet" href="/ticket/gzwhgy/themes/simplebootx/Portal/Events/Mobile/css/signUp.css">
    <title></title>
    <style>
        body{padding-bottom: 54px}
        #showPicker{
            position: relative;
            padding-bottom: 44px;
        }
         #showPicker span{
            position: absolute;
            bottom: 19px;
            font-size: 13px;
            color:rgba(0,0,0,0.5);
        }
        .weui-cells:after, .weui-cells:before{
            border: none;
        }
        .labelList .liBox{
            margin-bottom: 10px
        }
        .weui-cell:before{
            border-top: 1px dashed rgba(0,0,0,0.1)
        }
        .labelList .weui-cells:after{
            border-bottom: 1px solid rgba(0,0,0,0.1)
        }
        .weui-cells_form .weui-cell_active{}
        .confirmPay{
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        html{
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body>
<php>
    $max_num = C('wx_max_enroll');
</php>

    <section class="main">
    <!-- <form action="{:U('done_info')}" method="post" enctype="multipart/form-data"> -->
        <input type="hidden" name="active_id" value="{$info.id}"/>
        <div class="bannerBox">
            <img class="image" src="__ROOT__/data/upload/{$info.banner}"
                alt="">
            <h1>{$info.title}</h1>
        </div>

        <div class="selectBox">
            <div class="signUpNum">
                <div class="weui-cells">
                    <div class="weui-cell signUpNum">
                        <div class="weui-cell__bd">
                            <p>报名人数(成人)</p>
                        </div>
                        <div class="weui-cell__ft">
                            <div class="calc">
                                <button class="minus button disable"></button>
                                <input name="num" type="number" pattern="[0-9]*" class="num maxAddUser" value="1" readonly>
                                <button class="plus button"></button>
                            </div>
                        </div>
                    </div>
                    <a class="chird weui-cell  weui-cell_access" href="javascript:" id="showPicker">
                        <div class="weui-cell__bd">
                            <p>是否携带儿童</p>
                            <span>{$info.tips}</span>
                        </div>
                        <div class="weui-cell__bd weui-cell__ft pickerText" data-picker="0">否</div>
                        <input class="pickerTextInput" name="child" type="hidden" value="0">
                    </a>

                </div>
            </div>

        </div>

        <div class="labelList weui-form__control-area">
            <!-- <h2>活动现场将以所填信息为准进行核对，请正确填写!</h2> -->
            <div class="weui-cells__title">活动现场将以所填信息为准进行核对，请正确填写!</div>
            <ul class="ulContent">
                <li class="liBox">
                    <div class="">
                        <div class="weui-cells__group weui-cells__group_form">
                            <div class="weui-cells weui-cells_form">
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">姓名</label></div>
                                    <div class="weui-cell__bd">
                                        <input name="names[]" class="weui-input checkInput" placeholder="填写姓名" />
                                    </div>
                                </div>
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">年龄</label></div>
                                    <div class="weui-cell__bd">
                                        <input name="ages[]" type="number" pattern="[0-9]*" class="weui-input checkInput"
                                            placeholder="请填写年龄" />
                                    </div>
                                </div>
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">联系电话</label></div>
                                    <div class="weui-cell__bd">
                                        <input name="tels[]" class="weui-input checkInput" placeholder="请填写联系电话" type="number"
                                            pattern="[0-9]*" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        
    <!-- </form> -->
    </section>

    <div class="confirmPay">
            <div class="info">
                <p>报名费用总金额: &nbsp;<span class="allPrice"></span></p>
            </div>
            <div class="btn payBtn">
                <a href="javascript:" class="weui-btn weui-btn_primary ">确认提交报名</a>
            </div>
        </div>

<!-- 警告框-->
    <div class="weui-toptips weui-toptips_warn" id="Tips"></div>
    <div class="js_dialog" id="topTips" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd p"></div>
            <div class="weui-dialog__ft">
                <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_primary" style="line-height: 56px;">知道了</a>
            </div>
        </div>
    </div>


    <script src="/ticket/gzwhgy/themes/simplebootx/Portal/Events/Mobile/js/jquery.min.js"></script>
    <script src="https://res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>

    <script type="text/javascript">
        var maxAddUser = {$max_num};
        var price = {$info.price}
        
        var formItem = ` <li class="liBox">
            <div class="">
                <div class="weui-cells__group weui-cells__group_form">
                    <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label">姓名</label></div>
                        <div class="weui-cell__bd">
                            <input name="names[]"  class="weui-input checkInput" placeholder="填写姓名"/>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label">年龄</label></div>
                        <div class="weui-cell__bd">
                            <input name="ages[]"  type="number" pattern="[0-9]*" class="weui-input checkInput" placeholder="请填写年龄"/>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label">联系电话</label></div>
                        <div class="weui-cell__bd">
                            <input name="tels[]" class="weui-input checkInput" placeholder="请填写联系电话" type="number" pattern="[0-9]*" />
                        </div>
                    </div>
                    </div>
                </div>
            </div></li>`
        $(function () {
            var windheight = $(window).height();  /*未唤起键盘时当前窗口高度*/
        
        $(window).resize(function(){
           var docheight = $(window).height();  /*唤起键盘时当前窗口高度*/        
           if(docheight < windheight){            /*当唤起键盘高度小于未唤起键盘高度时执行*/
              $(".confirmPay").css("position","static");
           }else{
              $(".confirmPay").css("position","fixed");
           }           
        })

            calcPrice(1)
            $('#showPicker').on('click', function () {
                let that = $(this)
                weui.picker([{
                    label: '是',
                    value: 1
                }, {
                    label: '否',
                    value: 0
                }], {
                    onChange: function (result) {
                        console.log(result);
                    },
                    onConfirm: function (result) {
                        console.log(result);
                        $(".pickerText").html(result[0].label).attr("data-picker", result[0].value)
                        $(".pickerTextInput").val(result[0].value)
                    },
                    title: '是否携带儿童'
                });
            });

            $("#topTips a").on("click",function(params) {
                $("#topTips").fadeOut(200)
            })
            $(".minus").on("click", function () {

                let that = $(this);
                if (that.hasClass("disable")) {
                    return false;
                }
                var val = $(".num").val() - 1;
                console.log(val)
                if (val <= 1) {
                    that.addClass("disable")
                }
                $(".num").val(val);
                addFormItem(val)
                return false
            })
            $(".plus").on("click", function () {
                $(".minus").removeClass("disable")
                var val = $(".num").val() - 0 + 1;
                if (val > maxAddUser) {
                    // $('#topTips').html("最多添加人数：" + maxAddUser).fadeIn(200);
                    $('#topTips').fadeIn(200).find(".p").html("每个微信号最多只能报名" + maxAddUser+"人,您<br/>已超过限额，请修改报名人数");
                    // 每个微信号最多只能报名2人，您 
                    // 已超过限额，请修改报名人数
                    setTimeout(function() {
                        // $('#topTips').fadeOut(200);
                    },2000)
                    // weui.alert()
                    return false
                }
                $(".num").val(val);
                addFormItem(val)
                return false
            })

            $(".payBtn a").on("click",function(){
                var data = {
                    names:[],
                    tels:[],
                    ages:[]
                }
                let status = true
                $(".checkInput").each(function(item,index){
                    let that = $(this);
                    if(!that.val()){
                        // that.focus();
                        var p = that.parents(".weui-cell_active").find("label").text();
                        $("#Tips").html(p + "不能为空").fadeIn(200);
                        setTimeout(function(){
                            $("#Tips").fadeOut(200);
                        },2000)
                        status = false
                        return false
                    } else {

                        if(that.attr("name") == "names[]"){data.names.push(that.val())}
                        if(that.attr("name") == "tels[]"){
                            if(!checkPhone(that.val())){
                            $("#Tips").html("手机号码有误，请重填").fadeIn(200);
                                setTimeout(function(){
                                    $("#Tips").fadeOut(200);
                                },2000)
                                // that.focus();
                                status = false
                                return false
                            }else{
                                data.tels.push(that.val())
                            }
                        }
                        if(that.attr("name") == "ages[]"){data.ages.push(that.val())}
                    }
                })
                var url = "{:U('done_info')}";
                
                var params = {
                    active_id:"{$info.id}",
                    names:data.names,
                    tels:data.tels,
                    ages:data.ages,
                    num:$(".maxAddUser").val(),
                    child:$(".pickerTextInput").val()
                }
                console.log(params)
                setTimeout(function(){
                    if(status){
                        $.post(url,params,function(res){
                            console.log(res.info)
                            if(res.url){
                                window.location.href = res.url
                            }else {
                                $("#Tips").html(res.info).fadeIn(200);
                                setTimeout(function(){
                                    $("#Tips").fadeOut(200);
                                },2000)
                         // $('#topTips').fadeIn(200).find(".p").html(res.info);
                            }
                        },"json")
                    }
                },200)
                // $("form").submit()
            })
        });
        function addFormItem(num) {
            calcPrice(num)
            var liBox = $(".liBox");
            console.warn(liBox.length)
            if (liBox.length > num) {
                liBox[num].remove()
            } else {
                $(".ulContent").append(formItem)
            }
        }
        function calcPrice(num) {
            var pri = (price * num).toFixed(2)
            $(".allPrice").html("￥" + pri)
        }

    function checkPhone(phone){ 
        if(!(/^1[3456789]\d{9}$/.test(phone))){ 
            // alert("手机号码有误，请重填");  
            return false; 
        }else{
            return true;
        }
    }
    </script>
<!-- <script type="text/javascript" src="/ticket/gzwhgy/themes/simplebootx/Portal/Events/Mobile/js/selectedTimes.js"></script> -->

</body>

</html>